<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  </head>

  <style>
    .translated-input {
      background: #80808080;
    }
    
    .btn-container {
      background: #8080802b;
      padding: 0.8rem 1rem;
      border-radius: 0.5rem;
    }
    
    .loading-Message {
      display: none;
      position: fixed;
      width: 100%;
      height: 100vh;
      background-color: #2125296b;
      top: 0;
      left: 0;
      gap: 1.5rem;
    }
    .loading-Message div {
      display: flex;
      width: 100%;
      height: 100%;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
    }
    .loading-Message div .loading-Text {
      font-size: 2rem;
    }
  </style>

  <body>
    <div class="container">
      <div class="my-5">
        <form id="uploadForm" action="{% url 'index' %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <h1>XLIFF file tranlator app</h1>
          <!-- file input -->
          <input class="form-control my-3" type="file" id="formFile" name="xliff_file" required />

          <!-- Language Selection Dropdown -->
          <select class="form-select mb-3" id="languageSelect" name="target_language" required>
            <option value="" selected>Select a language</option>
            {% for option in languages %}
              <option value="{{ option.code }}">{{ option.name }}</option>
            {% endfor %}
          </select>

          <!-- Hidden Input to Store Selected Language -->
          <!-- submit -->
          <button type="submit" id="submitButton" class="btn btn-success">Translate</button>
          <!-- loader -->
          <div id="loadingMessage" class="loading-Message">
            <div>
              <span class="spinner-border text-dark" role="status" aria-hidden="true"></span>
              <span id="loadingText" class="loading-Text">Translating... Please wait.</span>
            </div>
          </div>
        </form>
      </div>

      {% if paired_data %}
        <div class="d-flex justify-content-end gap-3 btn-container">
          <button id="editButton" class="btn btn-info" onclick="enableEditing()">Edit</button>
          <button id="updateButton" class="btn btn-primary" onclick="getUpdatedValues()" style="display: none;">save changes</button>
          <button id="updateddownloadButton" class="btn btn-success" onclick="getEditedDownloadedFile()" style="display: none;">download edited file</button>
          <button id="downloadButton" class="btn btn-success" onclick="getDownloadedFile()">download file</button>
        </div>

        <table class="table">
          <thead class="thead-dark">
            <tr>
              <th>
                <h2>Source Text</h2>
              </th>
              <th>
                <h2>Translated Text</h2>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for source, translated in paired_data %}
              <tr class="translated-item">
                <td>{{ source }}</td>
                <td>
                  <span class="translated-text">{{ translated }}</span>
                  <textarea class="form-control translated-input" rows="4" cols="50" style="display: none;">{{ translated }}</textarea>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="text-info">Upload a file to see translations</p>
      {% endif %}
    </div>

    <script>
      /////////////////////////////////////////////enable Editing/////////////////////////////////////////
      function enableEditing() {
        document.querySelectorAll('.translated-item').forEach((item) => {
          item.querySelector('.translated-text').style.display = 'none'
          item.querySelector('.translated-input').style.display = 'inline-block'
        })
      
        document.getElementById('updateButton').style.display = 'inline-block'
        document.getElementById('downloadButton').style.display = 'none'
      }
      
      const getUpdatedValues = async () => {
        let updatedTranslated = []
        let updatedSource = []
        document.querySelectorAll('.translated-item .translated-input').forEach((input) => {
          updatedTranslated.push(input.value)
        })
        document.querySelectorAll('.source-item').forEach((item) => {
          updatedSource.push(item.innerText)
        })
      
        console.log('Updated Translated Data:', updatedTranslated)
        console.log('Updated Translated Data:', updatedSource)
      
        ////////////////////////////// sending post  request to backend for updating current array////////////////////////
        const response = await fetch("{% url 'update-translations' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            source_data: updatedSource,
            translated_data: updatedTranslated
          })
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Data updated successfully:', data)
          })
          .catch((error) => {
            console.error('Error updating data:', error)
          })
      
        ////////////////////////////////////////////////////// Restore normal view//////////////////////////////////////
        document.querySelectorAll('.translated-item').forEach((item) => {
          let span = item.querySelector('.translated-text')
          let input = item.querySelector('.translated-input')
          span.innerText = input.value
          span.style.display = 'inline-block'
          input.style.display = 'none'
        })
        document.getElementById('updateddownloadButton').style.display = 'inline-block'
      }
      
      /////////////////////////////////// getting downloaded file from response after updating  //////////////////////////
      const getEditedDownloadedFile = async () => {
      
        try {
          const response = await fetch("{% url 'download-edited-translations' %}", {
            method: 'GET',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}' // Ensure CSRF token is available
            }
          })
      
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
      
          const blob = await response.blob()
          const url = window.URL.createObjectURL(blob)
          const a = document.createElement('a')
          a.href = url
          a.download = 'translated.xlf' // Set the desired filename
          document.body.appendChild(a)
          a.click()
          window.URL.revokeObjectURL(url) // Clean up the URL object
        } catch (error) {
          console.error('Error downloading file:', error)
          // Handle error appropriately (e.g., display an error message)
        }
      }
      
      /////////////////////////////////// getting downloaded file from response   //////////////////////////
      const getDownloadedFile = async () => {
      
        try {
          const response = await fetch("{% url 'download-translations' %}", {
            method: 'GET',
            headers: {
              'X-CSRFToken': '{{ csrf_token }}' // Ensure CSRF token is available
            }
          })
      
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
      
          const blob = await response.blob()
          const url = window.URL.createObjectURL(blob)
          const a = document.createElement('a')
          a.href = url
          a.download = 'translated.xlf' // Set the desired filename
          document.body.appendChild(a)
          a.click()
          window.URL.revokeObjectURL(url) // Clean up the URL object
        } catch (error) {
          console.error('Error downloading file:', error)
          // Handle error appropriately (e.g., display an error message)
        }
      }
      
      ///////////////////////////////// loader/////////////////////////////////////////
      document.getElementById('uploadForm').addEventListener('submit', function () {
        // Show loading message immediately
        document.getElementById('loadingMessage').style.display = 'block'
      
        // After 20 seconds, update the text message
        setTimeout(function () {
          document.getElementById('loadingText').innerText = 'Translating... Please wait. If the file size is large, it could take few mins.'
        }, 20000) // 20 seconds delay
      })
      
 
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>
</html>
